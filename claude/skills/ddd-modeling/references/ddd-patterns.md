# DDDパターン リファレンス

## 目次

- [戦略的設計](#戦略的設計)
  - [境界づけられたコンテキスト](#境界づけられたコンテキストbounded-context)
  - [コンテキストマップ](#コンテキストマップ)
- [戦術的設計](#戦術的設計)
  - [エンティティ](#エンティティentity)
  - [値オブジェクト](#値オブジェクトvalue-object)
  - [集約](#集約aggregate)
  - [ドメインサービス](#ドメインサービス)
  - [ドメインイベント](#ドメインイベント)
  - [リポジトリ](#リポジトリ)
  - [ファクトリ](#ファクトリ)
- [モデリングのヒント](#モデリングのヒント)

## 戦略的設計

### 境界づけられたコンテキスト（Bounded Context）

同じ用語が異なる意味を持つ領域を明確に分離する。

**例**: 「商品」の意味
- 販売コンテキスト: 価格、在庫数、販売状態
- 配送コンテキスト: 重量、サイズ、配送区分
- 会計コンテキスト: 原価、仕入先、勘定科目

### コンテキストマップ

コンテキスト間の関係を表現する。

| 関係パターン | 説明 |
|-------------|------|
| 共有カーネル | 共通のモデルを共有 |
| 顧客/供給者 | 上流が下流の要求に応じる |
| 順応者 | 下流が上流に合わせる |
| 腐敗防止層 | 変換レイヤーで分離 |

## 戦術的設計

### エンティティ（Entity）

一意の識別子を持ち、ライフサイクルを通じて同一性を保つ。

**特徴:**
- IDで識別される
- 状態が変化しても同じオブジェクト
- ビジネスルールを持つ

**例**: 注文、顧客、商品

### 値オブジェクト（Value Object）

属性の組み合わせで等価性を判断する不変オブジェクト。

**特徴:**
- IDを持たない
- 不変（変更時は新しいインスタンスを作成）
- 等価性は属性で判断

**例**: 金額、住所、期間、数量

### 集約（Aggregate）

一貫性を保つ必要があるオブジェクトのまとまり。

**ルール:**
- 集約ルートを経由してのみアクセス
- トランザクション境界と一致
- 集約間は最終的整合性

**設計指針:**
- **必要な大きさにする**（小さくすべき、ではない）
- IDで参照する（オブジェクト参照ではなく）
- 境界外の変更は許可しない

**集約の大きさを決める基準:**

ビジネス上の不変条件が即座の整合性（atomic）を要求するかどうかで判断する。

| 状況 | 判断 |
|------|------|
| 「AとBは必ず同時に更新しないと業務が破綻する」 | 同じ集約（大きくなっても許容） |
| 「Bの更新は数秒〜数分遅れても問題ない」 | 別の集約 + 最終的整合性 |

**大きな集約が正当化される場面:**
- 金融系: 口座間送金、残高の整合性
- 予約系: 在庫とオーダーの同時確保
- 法的要件: 監査ログと本体データの同時記録

**トレードオフ:**
- 大きな集約: 即座の整合性、シンプルなトランザクション ↔ ロック競合、スケーラビリティ低下
- 小さな集約: 高スケーラビリティ ↔ 複雑な補償処理、一時的な不整合

技術的な都合でビジネスルールを曲げるのは本末転倒。ビジネス要件を分析して「atomicでないと困る」と判明したら、集約を大きくするのが正当な設計判断。

### ドメインサービス

エンティティや値オブジェクトに属さないドメインロジック。

**使用場面:**
- 複数の集約にまたがる操作
- 外部サービスとの連携
- 計算ロジック

### ドメインイベント

ドメインで発生した重要な出来事。

**命名規則:** 過去形で表現
- OrderPlaced（注文された）
- PaymentReceived（支払いを受領した）
- ShipmentDelivered（配送が完了した）

### リポジトリ

集約の永続化と取得を担当。

**原則:**
- 集約ルート単位で操作
- ドメイン層はインターフェースのみ定義
- 実装はインフラ層

### ファクトリ

複雑なオブジェクトの生成を担当。

**使用場面:**
- 生成ロジックが複雑
- 複数のオブジェクトを協調して生成
- 生成時のバリデーションが必要

## モデリングのヒント

### エンティティ vs 値オブジェクト

| 質問 | エンティティ | 値オブジェクト |
|------|-------------|---------------|
| IDで追跡する必要がある？ | Yes | No |
| ライフサイクルがある？ | Yes | No |
| 変更履歴を追う？ | Yes | No |
| 同じ属性なら同じもの？ | No | Yes |

### 集約の境界を決める

1. 一緒に変更される必要があるものは何か
2. トランザクションで保護すべき不変条件は何か
3. 独立して変更できるものは別の集約に

### よくある間違い

- **不必要に大きな集約**: ビジネス上の不変条件を超えて集約を大きくしない。注文明細は注文と同じ集約だが、商品マスタは別（即座の整合性が不要なら）
- **不必要に小さな集約**: atomicな更新が必要なのに別集約にすると、整合性を保てない
- **IDの代わりに参照**: 集約間はIDで参照。直接参照は避ける
- **貧血ドメインモデル**: ロジックをサービスに逃がさない。エンティティに振る舞いを持たせる
