---
description: "TDD方法論に従って新機能の実装やバグ修正を行う。RED→GREEN→REFACTORサイクルを厳格に遵守"
argument-hint: "[タスク説明]"
---

# /impl - TDD開発コマンド

このコマンドは、Kent BeckのTDD方法論と高凝集度・低結合度・コロケーションの原則に従って開発を行います。
developmentスキルを活用し、RED→GREEN→REFACTORサイクルをテストファーストアプローチで厳格に遵守します。

## 使い方

### 引数付き起動
```
/impl ログインフォームにバリデーションを追加
```

### 引数なし起動（対話的）
```
/impl
```

### コンテキストからの推論
事前の会話でタスクが明確な場合、コンテキストから理解します。

---

## [1/5] タスク準備

### タスク説明の取得

引数からタスク説明を取得します：
- `$1`が存在する場合: そのまま使用
- `$1`が空の場合: ユーザーに質問

```
タスク説明: $1
```

$1が空の場合、以下の質問をしてください：

「どのようなタスクを実装しますか？具体的なタスク説明を入力してください。

例：
- ユーザー認証にバリデーション機能を追加
- APIレスポンスのエラーハンドリングを修正
- 商品一覧のページネーションを実装
」

### 既存ドキュメントの確認

Readツールでdocs/DESIGN.mdとdocs/TODO.mdの存在を確認してください。

**docs/TODO.mdが存在する場合**：
- 内容を読み取り、該当するタスクがあるか確認
- 該当タスクがあれば、そのタスクの詳細を使用

**docs/DESIGN.mdが存在する場合**：
- 内容を読み取り、設計方針を把握
- 実装時の参考として使用

---

## [2/5] 設計思考（Design Thinking）

実装前に以下の観点で設計を検討し、ユーザーに確認します。

### 設計分析の実施

以下の観点で分析を行い、結果をユーザーに提示してください：

**1. 責務の明確化**
- この機能の単一責務は何か？
- この変更は既存の責務を侵害しないか？
- テストしやすい単位に分割できるか？

**2. 依存関係の分析**
- このモジュールが依存するものは何か？
- 依存を注入可能にできるか？（テストダブルで置換可能か）
- 循環依存が発生しないか？

**3. 配置の決定（コロケーション）**
- この機能はどこに配置すべきか？
- 関連するテスト・型・ヘルパーは同じ場所に配置できるか？
- 変更時に影響範囲が最小化されるか？

### ユーザー承認

AskUserQuestionツールを使用して設計方針の承認を取得してください：

```javascript
AskUserQuestion({
  questions: [
    {
      question: "設計分析が完了しました。\n\n[分析結果のサマリーを記載]\n\nこの設計方針で実装を進めてよろしいですか？",
      header: "設計承認",
      options: [
        {
          label: "承認",
          description: "この設計で実装を開始"
        },
        {
          label: "修正が必要",
          description: "設計方針を調整"
        },
        {
          label: "キャンセル",
          description: "開発を中断"
        }
      ],
      multiSelect: false
    }
  ]
})
```

**「修正が必要」を選択された場合**：
1. ユーザーに修正内容の詳細を質問
2. 設計を再分析

**「キャンセル」を選択された場合**：
- コマンドを終了
- 「開発を中断しました。再度実行する場合は /impl を使用してください」と表示

---

## [3/5] REDフェーズ - 失敗するテストを書く

### TodoWriteでタスク管理

TodoWriteツールを使用してREDフェーズのタスクを作成：

```javascript
TodoWrite({
  todos: [
    {
      content: "失敗するテストを書く（RED）",
      activeForm: "失敗するテストを書いている",
      status: "in_progress"
    },
    {
      content: "テストを通過させる最小限の実装（GREEN）",
      activeForm: "最小限の実装を書いている",
      status: "pending"
    },
    {
      content: "リファクタリング（REFACTOR）",
      activeForm: "リファクタリングしている",
      status: "pending"
    },
    {
      content: "品質チェック（lint, format, build, test）",
      activeForm: "品質チェックを実行している",
      status: "pending"
    }
  ]
})
```

### テストファイルの作成

コロケーションの原則に従い、実装ファイルと同じディレクトリにテストファイルを作成します。


**テスト作成のルール**：
- 実装ファイルと同じディレクトリに配置（例：`LoginForm.tsx` → `LoginForm.test.tsx`）
- 依存を注入可能にする（モック可能な設計）
- テストは具体的で意味のある名前を付ける
- Rustの場合は単体テストはモジュール内に記述

### テスト実行

テストを実行して**失敗を確認**します。

```bash
npm test -- --watch=false
```

**重要**: テストが失敗することを確認してください。これは期待通りの動作です。

---

## [4/5] GREENフェーズ - テストを通過させる

### 最小限の実装

TodoWriteツールを使用してGREENフェーズに移行：

```javascript
TodoWrite({
  todos: [
    {
      content: "失敗するテストを書く（RED）",
      activeForm: "失敗するテストを書いている",
      status: "completed"
    },
    {
      content: "テストを通過させる最小限の実装（GREEN）",
      activeForm: "最小限の実装を書いている",
      status: "in_progress"
    },
    // ... 残りのタスク
  ]
})
```

**実装のルール**：
- 現在のテストを通過するために**必要最小限**のコードのみ書く
- 将来の要件を先取りしない
- 過度な抽象化を避ける

### テスト実行

テストを実行して**成功を確認**します。

```bash
npm test -- --watch=false
```

**重要**: すべてのテストが通過することを確認してください。

---

## [5/5] REFACTORフェーズと完了

### リファクタリング（オプション）

**すべてのテストがグリーンの場合のみ**リファクタリングを行います。

TodoWriteツールを更新：

```javascript
TodoWrite({
  todos: [
    // 完了したタスク...
    {
      content: "リファクタリング（REFACTOR）",
      activeForm: "リファクタリングしている",
      status: "in_progress"
    },
    // ...
  ]
})
```

**リファクタリングの観点**：
- 高凝集度を維持しているか
- 低結合度を維持しているか
- 重複を排除できるか
- 命名は適切か

### 品質チェック（必須）

すべての品質チェックを実行します：

```bash
# プロジェクトに応じたコマンドを実行
npm run lint     # リンターを実行
npm run format   # フォーマッターを実行
npm run build    # ビルドを実行
npm test         # テストを実行
```

**重要**: すべてのチェックが通過するまでタスクは完了しません。

### セルフレビュー

品質チェック通過後、Skillツールを使用して review スキルを実行してセルフレビューを行います：

```javascript
Skill({
  skill: "review"
})
```

**レビュー結果に問題がある場合**：

AskUserQuestionツールを使用してユーザーに指示を仰ぎます：

```javascript
AskUserQuestion({
  questions: [
    {
      question: "セルフレビューで以下の問題が見つかりました：\n\n[問題点のサマリー]\n\nどのように対応しますか？",
      header: "レビュー結果",
      options: [
        {
          label: "修正する",
          description: "指摘された問題を修正してから再レビュー"
        },
        {
          label: "スキップ",
          description: "この問題は後で対応する"
        },
        {
          label: "中断",
          description: "開発を一時中断"
        }
      ],
      multiSelect: false
    }
  ]
})
```

**「修正する」を選択された場合**：
1. 指摘された問題を修正
2. 品質チェックを再実行
3. セルフレビューを再実行
4. 問題がなくなるまで繰り返す

**「スキップ」を選択された場合**：
- サイクルの継続確認に進む

**「中断」を選択された場合**：
- 「開発を中断しました。再度実行する場合は /impl を使用してください」と表示して終了

**レビューに問題がない場合**：
- TODO.mdの更新に進む

### TODO.mdの更新

docs/TODO.mdが存在し、現在のタスクが記載されている場合、完了したタスクにチェックをつけます。

**TODO.mdが存在する場合**：
1. Readツールでdocs/TODO.mdを読み込む
2. 実装したタスクに対応する行を特定
3. Editツールで `- [ ]` を `- [x]` に変更

```markdown
# 変更前
- [ ] ログインフォームにバリデーションを追加

# 変更後
- [x] ログインフォームにバリデーションを追加
```

**TODO.mdが存在しない場合**：
- スキップしてサイクルの継続確認に進む

### サイクルの継続確認

AskUserQuestionツールを使用して次のアクションを確認：

```javascript
AskUserQuestion({
  questions: [
    {
      question: "現在のRED-GREEN-REFACTORサイクルが完了しました。\n\n次のアクションを選択してください。",
      header: "次のアクション",
      options: [
        {
          label: "次のサイクル",
          description: "次のテストケース/機能を実装"
        },
        {
          label: "コミットして次へ",
          description: "現在の変更をコミットして次へ"
        },
        {
          label: "完了",
          description: "開発を終了"
        }
      ],
      multiSelect: false
    }
  ]
})
```

**「次のサイクル」を選択された場合**：
- [3/5] REDフェーズに戻る

**「コミットして次へ」を選択された場合**：
- committerスキルを使用してコミットを作成
- その後、「次のサイクル」または「完了」を再度確認

**「完了」を選択された場合**：
- 完了サマリーを表示

---

## 完了サマリー

### サマリー表示

以下の情報を表示してください：

```
✓ 開発が完了しました

実装内容:
- [実装した機能/修正のリスト]

作成/変更したファイル:
- [ファイルパスのリスト]

テスト結果:
- [テスト数] tests passed
```

### 次のステップ提案

以下のメッセージをユーザーに表示してください：

```
開発が完了しました。次のステップ：

1. コミット:
   まだコミットしていない場合は、変更をコミット

2. 追加の開発:
   他のタスクがある場合は、再度 /impl を実行
```

---

## 重要な注意事項

### TDD絶対ルール

1. **テストなしにコードを書かない** - 例外なし
2. **RED→GREEN→REFACTORサイクルに従う** - 厳格に遵守
3. **最小限の実装** - 現在のテストを通過するコードのみ書く
4. **グリーンの時のみリファクタリング** - テストが通過していなければリファクタリングしない

### アンチパターン（避けるべきこと）

❌ テストを「後で」書く
❌ テストを書く前に実装する
❌ テストがREDの時にリファクタリング
❌ 複数の機能を同時に実装
❌ 初期化のみチェックする意味のないテストを書く

### コミットガイドライン

```bash
# 構造変更（リファクタリング）
[STRUCTURAL] refactor: コンポーネントをfeatures/ディレクトリに移動

# 動作変更（機能追加・バグ修正）
[BEHAVIORAL] feat: ユーザー認証機能を追加
[BEHAVIORAL] fix: ログインエラーハンドリングを修正
```

### エラーハンドリング

- テスト実行エラー時は明確なエラーメッセージを表示
- ユーザーにリトライオプションを提供
- 品質チェック失敗時は修正を促す
