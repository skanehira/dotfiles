---
description: "ローカルのgit差分を自動検出し、TDD/テスト品質、コード品質、セキュリティ、アーキテクチャの4観点でコードレビューを実施。改善点があれば具体的な修正コードを提案。"
argument-hint: "[--staged | --all]"
allowed-tools: ["Bash(git status:*)", "Bash(git diff:*)", "Bash(git rev-parse:*)", "Read", "Glob", "Grep", "AskUserQuestion"]
---

# /review - コードレビューコマンド

ローカルのgit変更を自動検出し、4つの観点からコードレビューを実施します。

## 使い方

```
/review          # すべての変更をレビュー
/review --staged # ステージ済み変更のみ
```

---

## [1/5] 変更検出

### 引数の解析

```
引数: $ARGUMENTS
- --staged: ステージ済み変更のみ
- --all または 空: すべての変更
```

### gitリポジトリ確認

Bashツールで以下を実行してgitリポジトリか確認:
```bash
git rev-parse --git-dir 2>/dev/null
```

gitリポジトリでない場合:
「このディレクトリはgitリポジトリではありません。`/review`はgitリポジトリ内で実行してください。」と表示して終了。

### 変更ファイル取得

Bashツールで以下を実行:
```bash
git status --porcelain
```

### 差分取得

`$ARGUMENTS`が`--staged`の場合:
```bash
git diff --staged
```

それ以外の場合:
```bash
git diff
git diff --staged
```

### 変更がない場合

変更が0件の場合:
「レビュー対象の変更がありません。」と表示して終了。

### 変更サマリー表示

```
検出された変更:
- [ファイルパス] ([変更種別: 修正/新規/削除])
- ...

合計: N ファイル
```

---

## [2/5] コンテキスト収集

### 変更ファイルの読み込み

各変更ファイルについてReadツールで内容を読み込む。

### テストファイルの検索

Globツールで以下のパターンを検索し、変更ファイルに対応するテストを特定:
- `**/*_test.*`
- `**/*.test.*`
- `**/*_spec.*`
- `**/test_*.*`
- `**/__tests__/**`

対応関係の例:
- `foo.lua` → `foo_test.lua`, `foo_spec.lua`, `test_foo.lua`
- `foo.ts` → `foo.test.ts`, `foo.spec.ts`

### 関連ファイルの特定

変更ファイルに関連するすべての処理を把握するため、以下の手順で依存関係を追跡:

1. **インポート/依存関係の解析**:
   - 変更ファイル内の`import`, `require`, `from`文をGrepで抽出
   - インポート元のファイルをReadで読み込み
   - 変更が影響を与える可能性のあるファイルを特定

2. **逆依存関係の追跡**:
   - 変更ファイルをインポートしている他のファイルをGrepで検索
   - 変更による影響範囲を把握

3. **呼び出し関係の追跡**:
   - 変更された関数/クラス名をGrepで検索
   - 呼び出し元のファイルを特定し、影響範囲を確認

4. **同一モジュール内のファイル**:
   ```
   [変更ファイルのディレクトリ]/**/*
   ```

### プロジェクトパターンの確認

Grepツールで以下を検索:
- 類似の関数定義パターン
- インポート/require文
- 既存のテストパターン
- 変更されたAPIを使用している箇所

---

## [3/5] レビュー観点の選択と実施

### レビュー観点の選択

レビュー実施前に、AskUserQuestionツールでレビュー観点を選択させる:

```javascript
AskUserQuestion({
  questions: [
    {
      question: "どの観点でレビューしますか？（複数選択可）\n\n選択肢以外の観点でレビューしたい場合は「Other」を選択して入力してください。",
      header: "レビュー観点",
      options: [
        { label: "TDD/テスト品質", description: "テストの有無、カバレッジ、テストファースト準拠" },
        { label: "コード品質", description: "可読性、命名、複雑度、重複、凝集度、結合度" },
        { label: "セキュリティ", description: "脆弱性、認証/認可、入力検証" },
        { label: "アーキテクチャ", description: "設計パターン、依存関係、責務分離" }
      ],
      multiSelect: true
    }
  ]
})
```

**「Other」選択時の処理**:
- ユーザーが入力したカスタム観点でレビューを実施
- 例: 「パフォーマンス」「アクセシビリティ」「国際化対応」など
- カスタム観点の場合、その観点に関連するチェック項目を動的に生成

**デフォルト動作**:
- 選択がない場合、または引数に`--all`が指定されている場合は4観点すべてでレビュー

### 選択された観点のレビュー実施

選択された観点について以下のチェックを実施する。

### 3.1 TDD/テスト品質

**チェック項目**:

| 項目             | 重要度   | 確認内容                                                                 |
|------------------|----------|--------------------------------------------------------------------------|
| テストの存在     | Critical | 新規コードに対応するテストファイルが存在するか                           |
| テストカバレッジ | Warning  | 主要関数がテストされているか、エッジケース・エラーケースのテストがあるか |
| テスト品質       | Info     | テスト名が動作を説明しているか、AAAパターンに従っているか                |

**判定基準**:
- テストファイルが存在しない新規コード → **Critical**
- テストはあるがカバレッジ不足 → **Warning**
- テスト名が不明確 → **Info**

### 3.2 コード品質

**チェック項目**:

| 項目         | 重要度  | 確認内容                                                                                             |
|--------------|---------|------------------------------------------------------------------------------------------------------|
| 可読性       | Warning | 関数/変数名が意図を表現しているか、関数の長さ（目安: 50行以内）、ネストの深さ（目安: 3レベル以内）   |
| 命名規則     | Info    | プロジェクトの既存命名規則に従っているか                                                             |
| 重複         | Warning | 同一/類似コードが複数箇所にないか                                                                    |
| コメント     | Info    | 複雑なロジックに「なぜ」を説明するコメントがあるか                                                   |
| 不要コメント | Warning | 処理を翻訳しただけの無意味なコメントがないか（例: `i++; // iをインクリメント`）                      |
| 型安全性     | Warning | 適切な型定義、型ガードがあるか                                                                       |
| 凝集度       | Warning | モジュール/クラス/関数が単一の目的に集中しているか（機能的凝集が理想）                               |
| 結合度       | Warning | モジュール間の依存が最小限か、データ結合やメッセージ結合になっているか（内容結合・共通結合は避ける） |

**判定基準**:
- 関数が50行以上 → **Warning**（分割推奨）
- 同一コードが3箇所以上重複 → **Warning**
- マジックナンバー使用 → **Info**
- 処理を翻訳しただけのコメント → **Warning**（削除推奨）
- 低凝集（1つの関数/クラスに複数の無関係な責務） → **Warning**
- 高結合（グローバル変数への依存、内部実装への直接アクセス） → **Warning**

### 3.3 セキュリティ

**チェック項目**:

| 項目             | 重要度   | 確認内容                                                |
|------------------|----------|---------------------------------------------------------|
| シークレット管理 | Critical | ハードコードされたパスワード、APIキー、トークンがないか |
| 入力検証         | Critical | ユーザー入力のバリデーションがあるか                    |
| 認証/認可        | Warning  | 適切なアクセス制御があるか                              |
| インジェクション | Warning  | SQL、コマンド、XSSの脆弱性がないか                      |

**検索パターン**:
- `password`, `secret`, `api_key`, `token`
- `ghp_`, `sk-`, `aws_`, `AKIA`
- `eval(`, `exec(`, `system(`

**判定基準**:
- ハードコードされた秘密情報 → **Critical**
- 未検証のユーザー入力 → **Critical**
- eval/exec使用 → **Warning**

### 3.4 アーキテクチャ

**チェック項目**:

| 項目                   | 重要度  | 確認内容                                                              |
|------------------------|---------|-----------------------------------------------------------------------|
| 責務分離               | Warning | 単一責任原則に従っているか、1ファイル/1関数が単一の責務を持っているか |
| 既存パターンとの一貫性 | Warning | プロジェクトの既存パターンと一貫しているか                            |
| 依存関係               | Info    | 依存の方向が適切か（具象→抽象）                                       |
| Tidy First             | Warning | 構造変更と機能変更が混在していないか                                  |

**判定基準**:
- 循環依存 → **Warning**
- 既存パターンからの逸脱 → **Info**
- 構造変更と機能変更の混在 → **Warning**

---

## [4/5] レビュー結果表示

### サマリーテーブル

```markdown
# Code Review Report

## Summary
| 観点           | Critical | Warning | Info  |
|----------------|----------|---------|-------|
| TDD/テスト品質 | X        | X       | X     |
| コード品質     | X        | X       | X     |
| セキュリティ   | X        | X       | X     |
| アーキテクチャ | X        | X       | X     |
| **合計**       | **X**    | **X**   | **X** |
```

### Critical Issues (存在する場合)

各Critical Issueについて以下の形式で表示:
```markdown
### [観点] 問題タイトル
**ファイル**: `パス:行番号`
**問題**: 問題の説明
**推奨対応**: 対応方法
```

### Warnings (存在する場合)

各Warningについて以下の形式で表示:
```markdown
### [観点] 問題タイトル
**ファイル**: `パス:行番号`
**問題**: 問題の説明
**推奨対応**: 対応方法
```

### Info (存在する場合)

各Infoについて以下の形式で表示:
```markdown
### [観点] 提案タイトル
**ファイル**: `パス:行番号`
**提案**: 改善提案
```

---

## [5/5] 改善提案と対話

### ユーザー選択

レビュー結果を表示した後、AskUserQuestionツールを使用してユーザーに次のアクションを確認:

```javascript
AskUserQuestion({
  questions: [
    {
      question: "レビューでX件のCritical Issue、Y件のWarningが検出されました。\n\nどのように進めますか？",
      header: "レビュー結果",
      options: [
        {
          label: "Critical Issueをすべて修正",
          description: "最優先で対応すべき問題の修正コードを表示"
        },
        {
          label: "すべての問題を修正",
          description: "Critical + Warning の修正コードをまとめて表示"
        },
        {
          label: "特定の問題のみ修正",
          description: "修正したい問題を個別に選択"
        },
        {
          label: "レビュー完了",
          description: "修正せずにレビューを終了"
        }
      ],
      multiSelect: false
    }
  ]
})
```

### 修正コード提示

**「Critical Issueをすべて修正」「すべての問題を修正」「特定の問題のみ修正」選択時**:

各問題について以下の形式で修正案を提示:

````markdown
## 修正コード提案

### [観点] 問題タイトル

**現在のコード** (`ファイルパス:行番号`):
```言語
現在のコード
```

**修正案**:
```言語
修正後のコード
```

**変更理由**: 変更の根拠を説明
```

### 修正対象の選択

**「特定の問題のみ修正」選択時**:

検出された各指摘を選択肢として表示し、修正したい問題を直接選択させる（複数選択可）:

```javascript
AskUserQuestion({
  questions: [
    {
      question: "修正したい問題を選択してください（複数選択可）",
      header: "修正対象",
      options: [
        { label: "すべて修正", description: "検出されたすべての問題を修正" },
        { label: "[Critical] ハードコードされたAPIキー", description: "セキュリティ: config.lua:45" },
        { label: "[Critical] テストファイルが存在しない", description: "TDD: github-pr-reviewer.lua" },
        { label: "[Warning] 関数が長すぎる", description: "コード品質: utils.lua:120-180 (60行)" }
      ],
      multiSelect: true
    }
  ]
})
```

**注意**:
- AskUserQuestionのoptionsは最大4件のため、「すべて修正」+ 重要度順に上位3件を表示
- 残りの指摘を修正したい場合は「Other」で追加指定可能

````

選択された問題の修正コードを提示し、承認を得てから修正を適用。

---

## 重要な注意事項

### MUST Rules準拠
このレビューはCLAUDE.mdのMUST Rulesに準拠:
- **TDD準拠チェック**: テストファーストアプローチの確認
- **Tidy Firstチェック**: 構造変更と機能変更の分離確認
- **不確実性への対応**: 仮定を立てず、不明点は明確に報告

### レビュー対象外
- バイナリファイル
- 自動生成ファイル（`node_modules/`, `.git/`等）
- ロックファイル（`package-lock.json`, `Cargo.lock`等）
- 設定ファイル（`.gitignore`, `.editorconfig`等）

### エラーハンドリング
- gitリポジトリでない場合は明確なエラーメッセージを表示して終了
- ファイル読み込みエラーは該当ファイルをスキップして続行
- 100ファイル以上の変更がある場合は「`--staged`オプションで対象を絞ることを推奨」と警告を表示
